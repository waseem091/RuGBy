/*! For license information please see worker.js.LICENSE.txt */
(()=>{function e(r){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(r)}function r(){var e,n,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",a=o.toStringTag||"@@toStringTag";function c(r,o,i,a){var c=o&&o.prototype instanceof u?o:u,f=Object.create(c.prototype);return t(f,"_invoke",function(r,t,o){var i,a,c,u=0,f=o||[],l=!1,d={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(r,t){return i=r,a=0,c=e,d.n=t,s}};function p(r,t){for(a=r,c=t,n=0;!l&&u&&!o&&n<f.length;n++){var o,i=f[n],p=d.p,h=i[2];r>3?(o=h===t)&&(a=i[4]||3,c=i[5]===e?i[3]:i[5],i[4]=3,i[5]=e):i[0]<=p&&((o=r<2&&p<i[1])?(a=0,d.v=t,d.n=i[1]):p<h&&(o=r<3||i[0]>t||t>h)&&(i[4]=r,i[5]=t,d.n=h,a=0))}if(o||r>1)return s;throw l=!0,t}return function(o,f,h){if(u>1)throw TypeError("Generator is already running");for(l&&1===f&&p(f,h),a=f,c=h;(n=a<2?e:c)||!l;){i||(a?a<3?(a>1&&(d.n=-1),p(a,c)):d.n=c:d.v=c);try{if(u=2,i){if(a||(o="next"),n=i[o]){if(!(n=n.call(i,c)))throw TypeError("iterator result is not an object");if(!n.done)return n;c=n.value,a<2&&(a=0)}else 1===a&&(n=i.return)&&n.call(i),a<2&&(c=TypeError("The iterator does not provide a '"+o+"' method"),a=1);i=e}else if((n=(l=d.n<0)?c:r.call(t,d))!==s)break}catch(r){i=e,a=1,c=r}finally{u=1}}return{value:n,done:l}}}(r,i,a),!0),f}var s={};function u(){}function f(){}function l(){}n=Object.getPrototypeOf;var d=[][i]?n(n([][i]())):(t(n={},i,(function(){return this})),n),p=l.prototype=u.prototype=Object.create(d);function h(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,l):(e.__proto__=l,t(e,a,"GeneratorFunction")),e.prototype=Object.create(p),e}return f.prototype=l,t(p,"constructor",l),t(l,"constructor",f),f.displayName="GeneratorFunction",t(l,a,"GeneratorFunction"),t(p),t(p,a,"Generator"),t(p,i,(function(){return this})),t(p,"toString",(function(){return"[object Generator]"})),(r=function(){return{w:c,m:h}})()}function t(e,r,n,o){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}t=function(e,r,n,o){if(r)i?i(e,r,{value:n,enumerable:!o,configurable:!o,writable:!o}):e[r]=n;else{var a=function(r,n){t(e,r,(function(e){return this._invoke(r,n,e)}))};a("next",0),a("throw",1),a("return",2)}},t(e,r,n,o)}function n(e,r,t,n,o,i,a){try{var c=e[i](a),s=c.value}catch(e){return void t(e)}c.done?r(s):Promise.resolve(s).then(n,o)}function o(e,r,t){var n=e.createShader(r);if(!n)throw new Error("Could not create shader");if(e.shaderSource(n,t),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS))return n;var o=e.getShaderInfoLog(n);throw e.deleteShader(n),new Error("Could not compile shader: ".concat(o))}function i(e,r,t){var n=o(e,e.VERTEX_SHADER,r),i=o(e,e.FRAGMENT_SHADER,t),a=e.createProgram();if(!a)throw new Error("Could not create program");if(e.attachShader(a,n),e.attachShader(a,i),e.linkProgram(a),e.getProgramParameter(a,e.LINK_STATUS))return a;var c=e.getProgramInfoLog(a);throw e.deleteProgram(a),new Error("Could not link program: ".concat(c))}function a(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3?arguments[3]:void 0;console.time("cpu-render");for(var o=new Uint8ClampedArray(e*r*4),i=0;i<r;i++)for(var a=0;a<e;a++){var c=i*e+a,s=c+t,u=4*c;o[u]=s>>>16&255,o[u+1]=s>>>8&255,o[u+2]=255&s,o[u+3]=255}console.timeEnd("cpu-render");var f=n?performance.now()-n:0;return{pixels:o,renderTime:f,pixelsPerSecond:f>0?e*r/(f/1e3):0}}self.onmessage=function(){var e,t=(e=r().m((function e(t){var n,o,a,c,s,u,f,l,d,p,h,g,m,v,b,y,x,w,S,P;return r().w((function(e){for(;;)switch(e.n){case 0:if(n=t.data,o=n.width,a=n.height,c=n.baseIndex,s=void 0===c?0:c,n.bucketMode,u=n.startTime,e.p=1,console.time("rgb-render"),f=new OffscreenCanvas(o,a),l=f.getContext("webgl2")){e.n=2;break}throw new Error("WebGL2 not supported");case 2:d=i(l,"#version 300 es\n    in vec4 a_position;\n    void main() {\n      gl_Position = a_position;\n    }","#version 300 es\n    precision highp float;\n    uniform vec2 u_resolution;\n    uniform int u_baseIndex;\n    out vec4 outColor;\n    \n    void main() {\n      // Get pixel coordinates\n      vec2 pixelCoord = gl_FragCoord.xy;\n      \n      // Calculate the index (0 to 16,777,215)\n      int idx = int(pixelCoord.y * u_resolution.x + pixelCoord.x) + u_baseIndex;\n      \n      // Optimized bit-shift approach for RGB extraction\n      int r = (idx >> 16) & 0xFF;\n      int g = (idx >> 8) & 0xFF;\n      int b = idx & 0xFF;\n      \n      // Output color (normalized to 0-1)\n      outColor = vec4(float(r) / 255.0, float(g) / 255.0, float(b) / 255.0, 1.0);\n    }"),l.useProgram(d),p=l.getUniformLocation(d,"u_resolution"),l.uniform2f(p,o,a),h=l.getUniformLocation(d,"u_baseIndex"),l.uniform1i(h,s),g=l.getAttribLocation(d,"a_position"),m=l.createBuffer(),l.bindBuffer(l.ARRAY_BUFFER,m),v=[-1,-1,1,-1,-1,1,1,1],l.bufferData(l.ARRAY_BUFFER,new Float32Array(v),l.STATIC_DRAW),b=l.createVertexArray(),l.bindVertexArray(b),l.enableVertexAttribArray(g),l.vertexAttribPointer(g,2,l.FLOAT,!1,0,0),l.viewport(0,0,o,a),l.clearColor(0,0,0,0),l.clear(l.COLOR_BUFFER_BIT),l.drawArrays(l.TRIANGLE_STRIP,0,4),y=new Uint8Array(o*a*4),l.readPixels(0,0,o,a,l.RGBA,l.UNSIGNED_BYTE,y),console.timeEnd("rgb-render"),x=u?performance.now()-u:0,w=o*a/(x/1e3),self.postMessage({type:"pixels",width:o,height:a,pixels:y,renderTime:x,pixelsPerSecond:w,renderMethod:"webgl"},[y.buffer]),e.n=4;break;case 3:e.p=3,P=e.v,S=P instanceof Error?P.message:String(P),console.error("WebGL render error:",S),self.postMessage({type:"error",message:S,requiresFallback:!0});case 4:return e.a(2)}}),e,null,[[1,3]])})),function(){var r=this,t=arguments;return new Promise((function(o,i){var a=e.apply(r,t);function c(e){n(a,o,i,c,s,"next",e)}function s(e){n(a,o,i,c,s,"throw",e)}c(void 0)}))});return function(e){return t.apply(this,arguments)}}(),self.addEventListener("unhandledrejection",(function(r){if(console.error("Unhandled rejection in worker:",r.reason),r.reason&&"object"===e(r.reason)&&"data"in r.reason){var t=r.reason.data,n=t.width,o=t.height,i=t.baseIndex,c=void 0===i?0:i,s=t.startTime;console.warn("Falling back to CPU rendering due to error:",r.reason);try{var u=a(n,o,c,s),f=u.pixels,l=u.renderTime,d=u.pixelsPerSecond;self.postMessage({type:"pixels",width:n,height:o,pixels:f,renderTime:l,pixelsPerSecond:d,renderMethod:"cpu-fallback"},[f.buffer])}catch(e){var p=e instanceof Error?e.message:String(e);self.postMessage({type:"error",message:"Both WebGL and CPU rendering failed: ".concat(p)})}}})),self.addEventListener("message",(function(e){var r=e.data;if("cpu-fallback"===r.type){var t=r.width,n=r.height,o=r.baseIndex,i=void 0===o?0:o,c=r.startTime;try{var s=a(t,n,i,c),u=s.pixels,f=s.renderTime,l=s.pixelsPerSecond;self.postMessage({type:"pixels",width:t,height:n,pixels:u,renderTime:f,pixelsPerSecond:l,renderMethod:"cpu"},[u.buffer])}catch(e){var d=e instanceof Error?e.message:String(e);self.postMessage({type:"error",message:"CPU rendering failed: ".concat(d)})}}}))})();